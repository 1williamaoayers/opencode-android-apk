name: Build Android APK

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.4'
          channel: stable

      - name: Flutter info
        run: flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: Get previous release tag
        id: prev_release
        run: |
          # 获取完整 git 历史
          git fetch --unshallow --tags
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            PREV_TAG=$(git describe --tags --abbrev=0)
            echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          else
            echo "previous_tag=v0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        id: version
        run: |
          PREV_TAG=${{ steps.prev_release.outputs.previous_tag }}
          # 提取版本号并递增
          VERSION=$(echo $PREV_TAG | sed 's/^v//')
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # 自动递增 patch 版本
          PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping version: $PREV_TAG -> $NEW_VERSION"

      - name: Build Release APK
        run: flutter build apk --release

      - name: Verify APK exists
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            echo "✅ APK built successfully"
            ls -lh "$APK_PATH"
          else
            echo "❌ APK not found!"
            find build/ -name "*.apk" 2>/dev/null || echo "No APK files found"
            exit 1
          fi

      - name: Create Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG_EXISTS=$(git ls-remote --tags origin $NEW_VERSION 2>/dev/null | wc -l)
          
          if [ "$TAG_EXISTS" -gt 0 ]; then
            # Tag exists, increment until we find a free one
            VERSION_NUM=$(echo $NEW_VERSION | sed 's/^v//')
            while [ "$TAG_EXISTS" -gt 0 ]; do
              VERSION_NUM=$(echo $VERSION_NUM | awk -F. '{print $1"."$2"."$3+1}')
              NEW_VERSION="v$VERSION_NUM"
              TAG_EXISTS=$(git ls-remote --tags origin $NEW_VERSION 2>/dev/null | wc -l)
            done
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "Bumped to: $NEW_VERSION"
          fi
          
          git tag $NEW_VERSION
          git push origin $NEW_VERSION || echo "Push failed but continuing..."

      - name: Upload APK to Release
        run: |
          # Get the actual tag that was pushed
          TAG=$(git describe --tags --abbrev=0 origin/master 2>/dev/null || echo "${{ steps.version.outputs.new_version }}")
          echo "Uploading release for tag: $TAG"
          
          # Create release if not exists, then upload
          gh release create "$TAG" --title "$TAG" --notes "Auto-built APK" || true
          gh release upload "$TAG" build/app/outputs/flutter-apk/app-release.apk --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
