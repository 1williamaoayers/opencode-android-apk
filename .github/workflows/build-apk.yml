name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'platform-tools platforms;android-34 build-tools;34.0.0'

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Monorepo Dependencies
        run: |
          cd opencode
          bun install

      - name: Build Frontend
        run: |
          cd opencode/packages/app
          bun run build
      
      - name: Prepare Android App
        run: |
          mkdir -p android-app/dist
          cp -r opencode/packages/app/dist/* android-app/dist/
          
          cd android-app
          npm install

      - name: Initialize Capacitor and Add Android
        run: |
          cd android-app
          
          # 初始化 Capacitor（如果还没有）
          if [ ! -f "capacitor.config.ts" ]; then
            npx cap init "OpenCode" "com.opencode.android" --web-dir=dist
          fi
          
          # 添加 Android 平台（如果还没有）
          if [ ! -d "android" ]; then
            npx cap add android
          fi
          
          # 同步 Web 资源到 Android
          npx cap sync android

          # 修改 AndroidManifest.xml 允许明文流量 (HTTP)
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/g' android/app/src/main/AndroidManifest.xml

      - name: Build debug APK
        id: build_apk
        run: |
          cd android-app/android
          
          # 构建 Debug APK
          chmod +x gradlew
          ./gradlew assembleDebug
          
          # 检查 APK 是否生成
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "APK_BUILD_ENABLED=true" >> $GITHUB_OUTPUT
            echo "APK_PATH=app/build/outputs/apk/debug/app-debug.apk" >> $GITHUB_OUTPUT
          else
            echo "APK_BUILD_ENABLED=false" >> $GITHUB_OUTPUT
            ls -la app/build/outputs/apk/ 2>/dev/null || echo "No apk directory"
          fi

      - name: Generate Debug Keystore and Sign APK
        id: sign_apk
        run: |
          cd android-app/android
          
          # 生成 debug keystore
          keytool -genkey -v -keystore app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US" -noprompt
          
          # 签名 APK
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign --ks app/debug.keystore --ks-pass pass:android --key-pass pass:android app/build/outputs/apk/debug/app-debug.apk
          
          echo "APK_SIGNED=true" >> $GITHUB_OUTPUT

      - name: Upload APK to Release
        if: steps.build_apk.outputs.APK_BUILD_ENABLED == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-app/android/app/build/outputs/apk/debug/app-debug.apk
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
