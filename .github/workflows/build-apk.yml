name: Build Android APK

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.4'
          channel: stable

      - name: Flutter info
        run: flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Get previous release tag
        id: prev_release
        run: |
          # 获取远程最新 tag
          git fetch --tags
          if git describe --tags --abbrev=0 origin/master >/dev/null 2>&1; then
            PREV_TAG=$(git describe --tags --abbrev=0 origin/master)
            echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          else
            echo "previous_tag=v0.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        id: version
        run: |
          PREV_TAG=${{ steps.prev_release.outputs.previous_tag }}
          # 提取版本号并递增
          VERSION=$(echo $PREV_TAG | sed 's/^v//')
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # 自动递增 patch 版本
          PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping version: $PREV_TAG -> $NEW_VERSION"

      - name: Build Release APK
        run: flutter build apk --release

      - name: Verify APK exists
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            echo "✅ APK built successfully"
            ls -lh "$APK_PATH"
          else
            echo "❌ APK not found!"
            find build/ -name "*.apk" 2>/dev/null || echo "No APK files found"
            exit 1
          fi

      - name: Create Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.version.outputs.new_version }}
          git push origin ${{ steps.version.outputs.new_version }} || echo "Tag already exists, skipping"

      - name: Upload APK to Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
          name: ${{ steps.version.outputs.new_version }}
          tag_name: ${{ steps.version.outputs.new_version }}
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
