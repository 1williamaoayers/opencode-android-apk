name: Emulator UI Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-12
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Latest Release APK
        run: |
          gh release download v0.0.9 -D apks -p "*.apk"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
      - name: Run Emulator & Take Screenshot
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          script: |
            echo "Installing APK..."
            adb install apks/app-release.apk
            echo "Starting App..."
            adb shell monkey -p com.opencode.mobile -c android.intent.category.LAUNCHER 1
            echo "Waiting for app to load..."
            sleep 15
            echo "Inputting server URL..."
            adb shell input text "http://43.255.122.29:19898"
            adb shell input keyevent 61 # TAB to username
            adb shell input text "danxon"
            adb shell input keyevent 61 # TAB to password
            adb shell input text "2379126x"
            adb shell input keyevent 66 # ENTER/Connect
            echo "Waiting 20 seconds for WebView Auth..."
            sleep 20
            echo "Taking Screenshot..."
            adb shell screencap -p /sdcard/screenshot.png
            adb pull /sdcard/screenshot.png ./screenshot.png
            echo "Dumping logcat..."
            adb logcat -d > logcat.txt

      - name: Upload Screenshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-screenshot
          path: screenshot.png

      - name: Upload Logcat Artifact
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logcat
          path: logcat.txt
